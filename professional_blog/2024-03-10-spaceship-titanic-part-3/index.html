<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-03-10">
<meta name="description" content="Fighting back against the aliens using GAMs and ROC.">

<title>bites | brews | paws - Spaceship Titanic - Introduction to Bayesian Models - Part 3</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../..//img/favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/elevatorjs-1.0.0/elevator.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-TLJMCG2VMV"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-TLJMCG2VMV', { 'anonymize_ip': true});
</script>
<link href="../../site_libs/tabwid-1.1.3/tabwid.css" rel="stylesheet">
<script src="../../site_libs/tabwid-1.1.3/tabwid.js"></script>
<link href="https://iosevka-webfonts.github.io/iosevka/Iosevka.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="bites | brews | paws - Spaceship Titanic - Introduction to Bayesian Models - Part 3">
<meta property="og:description" content="Fighting back against the aliens using GAMs and ROC.">
<meta property="og:image" content="https://sinisterrob.github.io/../../assets/img/titanic-3.png">
<meta property="og:site_name" content="bites | brews | paws">
<meta property="og:locale" content="es_ES">
<meta name="twitter:title" content="bites | brews | paws - Spaceship Titanic - Introduction to Bayesian Models - Part 3">
<meta name="twitter:description" content="Fighting back against the aliens using GAMs and ROC.">
<meta name="twitter:image" content="https://sinisterrob.github.io/../../assets/img/titanic-3.png">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">bites | brews | paws</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about_me.html"> 
<span class="menu-text">About Me</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-personal-reviews" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Personal Reviews</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-personal-reviews">    
        <li>
    <a class="dropdown-item" href="../../food_review.html">
 <span class="dropdown-text">Food Reviews</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../music_review.html">
 <span class="dropdown-text">Music Reviews</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../book_review.html">
 <span class="dropdown-text">Book Reviews</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-blogs--analysis" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Blogs &amp; Analysis</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-blogs--analysis">    
        <li>
    <a class="dropdown-item" href="../../chess_analysis.html">
 <span class="dropdown-text">Chess Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../personal_blog.html">
 <span class="dropdown-text">Personal Blog</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../professional_blog.html">
 <span class="dropdown-text">Professional Blog</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../photography.html"> 
<span class="menu-text">Photography</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog_subscribe.html"> 
<span class="menu-text">Subscribe to bites | brews | paws!</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul class="collapse">
  <li><a href="#part-3-further-refinement" id="toc-part-3-further-refinement" class="nav-link active" data-scroll-target="#part-3-further-refinement">Part 3: Further Refinement</a>
  <ul class="collapse">
  <li><a href="#age-is-non-linear" id="toc-age-is-non-linear" class="nav-link" data-scroll-target="#age-is-non-linear">Age is Non-Linear</a></li>
  <li><a href="#breaking-down-the-cabin-field" id="toc-breaking-down-the-cabin-field" class="nav-link" data-scroll-target="#breaking-down-the-cabin-field">Breaking Down the Cabin Field</a></li>
  <li><a href="#second-model-run" id="toc-second-model-run" class="nav-link" data-scroll-target="#second-model-run">Second Model Run</a></li>
  <li><a href="#roc---we-have-two-models-which-is-better" id="toc-roc---we-have-two-models-which-is-better" class="nav-link" data-scroll-target="#roc---we-have-two-models-which-is-better">ROC - We have two models, which is better?</a></li>
  <li><a href="#summary-part-4-preview" id="toc-summary-part-4-preview" class="nav-link" data-scroll-target="#summary-part-4-preview">Summary + Part 4 Preview</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Spaceship Titanic - Introduction to Bayesian Models - Part 3</h1>
</div>

<div>
  <div class="description">
    Fighting back against the aliens using GAMs and ROC.
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 10, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="cell">
<style type="text/css">
table {
  width: 50%;
  margin-left: auto;
  margin-right: auto;
}
</style>
</div>
<div style="text-align: center;">
<p><img src="../../assets/img/titanic-3.png" class="img-fluid" width="350"></p>
</div>
<section id="part-3-further-refinement" class="level1">
<h1>Part 3: Further Refinement</h1>
<p>Welcome to Part 3 of my Introduction to Bayesian Models series.</p>
<p>If you haven’t read Part 1 or Part 2 yet, I really suggest reading those first so that you don’t think I’m rambling about aliens for no reason.</p>
<ul>
<li><p><a href="../../professional_blog/2024-03-08-spaceship-titanic-part-1/index.html">Part 1 Link</a></p></li>
<li><p><a href="../../professional_blog/2024-03-09-spaceship-titanic-part-2/index.html">Part 2 Link</a></p></li>
</ul>
<p>In Part 3 we will try to improve the accuracy of our model by exploring generalized additive models (GAMs), and also examine the ROC curves of the model.</p>
<section id="age-is-non-linear" class="level2">
<h2 class="anchored" data-anchor-id="age-is-non-linear">Age is Non-Linear</h2>
<p>The first thing I want to address in our model is the Age variable.</p>
<p>Including Age as a linear predictor probably captured some of the effects that it has, but in our univariate analysis we showed that the relationship Age has with Transported Status is not necessarily linear.</p>
<div style="text-align: center;">
<p><img src="../../assets/img/age_transport.png" class="img-fluid"></p>
</div>
<p>In fact, it’s hard to even visualize a continuous variable against a TRUE/FALSE response variable, and you might even be wondering what that blue line means, since it’s not the Age variable and it’s not the Transported variable.</p>
<p>When I originally plotted this line in <a href="../../professional_blog/2024-03-08-spaceship-titanic-part-1/index.html">Part 1</a>, I used a technique called <code>loess</code> which is a method for smoothing a relationship between two variables, for example <code>Transportation ~ Age</code>.</p>
<p>My idea for a more effective use of Age in the model is this:</p>
<ul>
<li><p>What if instead of using the Age variable directly, we applied some mapping from Age to a quantity close to the blue line in the graph, and then used that newly fitted value as our predictive variable instead of Age?</p></li>
<li><p>This should capture the relationship between Age and Transported more effectively than a linear relationship, with the drawback that the model coefficients aren’t as easily interpretable, and we run the risk of over-fitting. Ideally we should produce a somewhat generalized fit without jagged points to reduce the over-fitting risk.</p></li>
<li><p>Similar idea to the blue line: We can use a <a href="https://en.wikipedia.org/wiki/Generalized_additive_model">generalized additive model</a> (GAM) to fit the univariate model <code>Transportation ~ Age</code>, and then replace the Age column with the fit from this model.</p></li>
</ul>
<section id="fitting-the-gam-model." class="level4">
<h4 class="anchored" data-anchor-id="fitting-the-gam-model.">Fitting the GAM model.</h4>
<p>Let’s fit a GAM model between Transportation and Age using the <code>mcgv</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>age_model <span class="ot">&lt;-</span> <span class="fu">gam</span>(Transported <span class="sc">~</span> <span class="fu">s</span>(Age), <span class="at">data =</span> imputed_sst_data, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>age_grid <span class="ot">&lt;-</span> <span class="fu">with</span>(imputed_sst_data, <span class="fu">data.frame</span>(<span class="at">Age =</span> <span class="fu">seq</span>(<span class="fu">min</span>(Age, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="fu">max</span>(Age, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">length.out =</span> <span class="dv">100</span>)))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>age_grid<span class="sc">$</span>Predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(age_model, <span class="at">newdata =</span> age_grid, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(age_grid, <span class="fu">aes</span>(<span class="at">x =</span> Age, <span class="at">y =</span> Predicted)) <span class="sc">+</span> </span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#2C3E50"</span>) <span class="sc">+</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Predicted <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span><span class="fu">sqrt</span>(Predicted <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Predicted) <span class="sc">/</span> <span class="fu">nrow</span>(age_grid)),</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ymax =</span> Predicted <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span><span class="fu">sqrt</span>(Predicted <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Predicted) <span class="sc">/</span> <span class="fu">nrow</span>(age_grid))),</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rj_custom_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>That definitely looks line an interesting and non-linear relationship. I will append the predictions back to my original data set and call the new column Age_Pred.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>imputed_sst_data<span class="sc">$</span>Age_Pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(age_model, imputed_sst_data, <span class="at">type =</span> <span class="st">"response"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="breaking-down-the-cabin-field" class="level2">
<h2 class="anchored" data-anchor-id="breaking-down-the-cabin-field">Breaking Down the Cabin Field</h2>
<p>The other variable I wanted to add to our next model iteration was Cabin.</p>
<p>The cabin number where the passenger is staying. It takes the form <code>deck/num/side</code>, where side can be either P for Port or S for Starboard.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>imputed_sst_data <span class="sc">%&gt;%</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Cabin) <span class="sc">%&gt;%</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  head <span class="sc">%&gt;%</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rj_custom_table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="tabwid"><style>.cl-1c25261c{}.cl-1c1a49cc{font-family:'Iosevka Web';font-size:11pt;font-weight:bold;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-1c1a49e0{font-family:'Iosevka Web';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-1c1e39ce{margin:0;text-align:center;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-1c1e4e96{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(190, 190, 190, 1.00);border-top: 1.5pt solid rgba(190, 190, 190, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-1c1e4ea0{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-1c1e4ea1{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(190, 190, 190, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table data-quarto-disable-processing="true" class="cl-1c25261c"><thead><tr style="overflow-wrap:break-word;"><th class="cl-1c1e4e96"><p class="cl-1c1e39ce"><span class="cl-1c1a49cc">Cabin</span></p></th></tr></thead><tbody><tr style="overflow-wrap:break-word;"><td class="cl-1c1e4ea0"><p class="cl-1c1e39ce"><span class="cl-1c1a49e0">B/0/P</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-1c1e4ea0"><p class="cl-1c1e39ce"><span class="cl-1c1a49e0">F/0/S</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-1c1e4ea0"><p class="cl-1c1e39ce"><span class="cl-1c1a49e0">A/0/S</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-1c1e4ea0"><p class="cl-1c1e39ce"><span class="cl-1c1a49e0">A/0/S</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-1c1e4ea0"><p class="cl-1c1e39ce"><span class="cl-1c1a49e0">F/1/S</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-1c1e4ea1"><p class="cl-1c1e39ce"><span class="cl-1c1a49e0">F/0/P</span></p></td></tr></tbody></table></div>
</div>
</div>
<p>Implementing the information from the Cabin variable takes a little more complex data manipulation:</p>
<ul>
<li><p>Split <code>Cabin</code> into three variables called <code>deck</code>, <code>num</code>, and <code>side</code>.</p></li>
<li><p>Impute <code>deck</code>, <code>num</code>, or <code>side</code> values.</p></li>
<li><p>Use the same GAM strategy on <code>num</code> also, which is to fit a GAM model <code>Transportation ~ num</code> so that we can capture the non-linear effect.</p></li>
<li><p>We can also create an indicator variable from the <code>Cabin</code> field. If multiple people are staying in the same Cabin then we can set a new variable called <code>CabinMult</code> to TRUE, and FALSE otherwise.</p>
<ul>
<li>I’ll do this before imputing any of the missing variables to avoid creating it using imputed data.</li>
</ul></li>
<li><p>Later, when I do the full model fit and submission to Kaggle, I’ll probably impute all missing variables at once (and also on the test set as well) instead of imputing one at a time.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>cabin_sst_data <span class="ot">&lt;-</span> imputed_sst_data <span class="sc">%&gt;%</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">separate</span>(Cabin, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"deck"</span>, <span class="st">"num"</span>, <span class="st">"side"</span>), <span class="at">sep =</span> <span class="st">"/"</span>, <span class="at">remove =</span> <span class="cn">FALSE</span>, <span class="at">fill =</span> <span class="st">"right"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">deck =</span> <span class="fu">ifelse</span>(deck <span class="sc">==</span> <span class="st">""</span>, <span class="cn">NA</span>, deck)) <span class="sc">%&gt;%</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(deck, num, side) <span class="sc">%&gt;%</span> </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">people_in_room =</span> <span class="fu">n</span>(),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">CabinMult =</span> <span class="fu">ifelse</span>(people_in_room <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(deck), <span class="cn">TRUE</span>, <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(Cabin, people_in_room)) <span class="sc">%&gt;%</span> </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">deck =</span> <span class="fu">factor</span>(deck),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">num =</span> <span class="fu">as.numeric</span>(num),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">side =</span> <span class="fu">factor</span>(side))</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>cabin_no_transport <span class="ot">&lt;-</span> cabin_sst_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="st">"Transported"</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>cabin_transport <span class="ot">&lt;-</span> cabin_sst_data <span class="sc">%&gt;%</span> <span class="fu">pull</span>(<span class="st">"Transported"</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>imputed_cabin <span class="ot">&lt;-</span> <span class="fu">mice</span>(cabin_no_transport, <span class="at">m =</span> <span class="dv">1</span>, <span class="at">printFlag =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>imputed_cabin_data <span class="ot">&lt;-</span> <span class="fu">complete</span>(imputed_cabin, <span class="dv">1</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>imputed_cabin_data<span class="sc">$</span>Transported <span class="ot">&lt;-</span> cabin_transport</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>imputed_cabin_data <span class="ot">&lt;-</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  imputed_cabin_data <span class="sc">%&gt;%</span> </span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">HomePlanet =</span> <span class="fu">factor</span>(HomePlanet, <span class="at">levels =</span> <span class="fu">unique</span>(HomePlanet)),</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">VIP =</span> <span class="fu">factor</span>(VIP, <span class="at">levels =</span> <span class="fu">unique</span>(VIP)),</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">deck =</span> <span class="fu">factor</span>(deck, <span class="at">levels =</span> <span class="fu">unique</span>(deck)),</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>         <span class="at">side =</span> <span class="fu">factor</span>(side, <span class="at">levels =</span> <span class="fu">unique</span>(side)))</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>num_model <span class="ot">&lt;-</span> <span class="fu">gam</span>(Transported <span class="sc">~</span> <span class="fu">s</span>(num), <span class="at">data =</span> imputed_cabin_data, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>imputed_cabin_data<span class="sc">$</span>num_Pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(num_model, imputed_cabin_data, <span class="at">type =</span> <span class="st">"response"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have the <code>Cabin</code> field broken out into <code>deck</code>, <code>num</code>, and <code>side</code>, we can create the design matrix, update the Stan code, and fit the model.</p>
<p>Notice that currently we will be estimating a <span class="math inline">\(\beta\)</span> parameter for every deck on the ship, which is called a <a href="https://en.wikipedia.org/wiki/Fixed_effects_model">fixed effects</a> model. But what if each deck is not that different from each other? If that is the case, we could set up a different structure for this effect, where each <span class="math inline">\(\beta_{deck}\)</span> was drawn from a common distribution, and the parameters of that distribution were estimated instead of the <span class="math inline">\(\beta_{deck}\)</span> themselves?</p>
<p>That describes a <a href="https://en.wikipedia.org/wiki/Mixed_model">mixed-effects</a> model, and it might be a better fit in the future when I have time to properly implement it in Stan. The benefits of this approach would be we only need to estimate <strong>one</strong> effect <span class="math inline">\(\beta\)</span> and standard deviation <span class="math inline">\(\sigma\)</span>, instead of estimating a separate <span class="math inline">\(\beta\)</span> for every deck on the ship. It would also mean that for the decks where we don’t have a lot of data, more natural credibility would have to be given to the overall mean since the prior and posterior have to be close to each other when you don’t have much data.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>imputed_cabin_data <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model.matrix</span>(<span class="st">`</span><span class="at">Transported</span><span class="st">`</span> <span class="sc">~</span> <span class="st">`</span><span class="at">Age_Pred</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">VIP</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">HomePlanet</span><span class="st">`</span> <span class="sc">+</span> deck <span class="sc">+</span> num <span class="sc">+</span> side <span class="sc">+</span> CabinMult <span class="sc">+</span> num_Pred, <span class="at">data =</span> .) <span class="sc">%&gt;%</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rj_custom_table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="tabwid"><style>.cl-204e5164{}.cl-2045e25e{font-family:'Iosevka Web';font-size:11pt;font-weight:bold;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-2045e268{font-family:'Iosevka Web';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-2048cc76{margin:0;text-align:center;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-2048dd42{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(190, 190, 190, 1.00);border-top: 1.5pt solid rgba(190, 190, 190, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-2048dd4c{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-2048dd4d{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(190, 190, 190, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table data-quarto-disable-processing="true" class="cl-204e5164"><thead><tr style="overflow-wrap:break-word;"><th class="cl-2048dd42"><p class="cl-2048cc76"><span class="cl-2045e25e">(Intercept)</span></p></th><th class="cl-2048dd42"><p class="cl-2048cc76"><span class="cl-2045e25e">Age_Pred</span></p></th><th class="cl-2048dd42"><p class="cl-2048cc76"><span class="cl-2045e25e">VIPTRUE</span></p></th><th class="cl-2048dd42"><p class="cl-2048cc76"><span class="cl-2045e25e">HomePlanetEarth</span></p></th><th class="cl-2048dd42"><p class="cl-2048cc76"><span class="cl-2045e25e">HomePlanetMars</span></p></th><th class="cl-2048dd42"><p class="cl-2048cc76"><span class="cl-2045e25e">deckF</span></p></th><th class="cl-2048dd42"><p class="cl-2048cc76"><span class="cl-2045e25e">deckA</span></p></th><th class="cl-2048dd42"><p class="cl-2048cc76"><span class="cl-2045e25e">deckG</span></p></th><th class="cl-2048dd42"><p class="cl-2048cc76"><span class="cl-2045e25e">deckE</span></p></th><th class="cl-2048dd42"><p class="cl-2048cc76"><span class="cl-2045e25e">deckD</span></p></th><th class="cl-2048dd42"><p class="cl-2048cc76"><span class="cl-2045e25e">deckC</span></p></th><th class="cl-2048dd42"><p class="cl-2048cc76"><span class="cl-2045e25e">deckT</span></p></th><th class="cl-2048dd42"><p class="cl-2048cc76"><span class="cl-2045e25e">num</span></p></th><th class="cl-2048dd42"><p class="cl-2048cc76"><span class="cl-2045e25e">sideS</span></p></th><th class="cl-2048dd42"><p class="cl-2048cc76"><span class="cl-2045e25e">CabinMultTRUE</span></p></th><th class="cl-2048dd42"><p class="cl-2048cc76"><span class="cl-2045e25e">num_Pred</span></p></th></tr></thead><tbody><tr style="overflow-wrap:break-word;"><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0.4854453</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0.5059402</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0.4693185</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0.5059402</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0.4861707</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0.5059402</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0.4758734</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0.5059402</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0.5182632</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4c"><p class="cl-2048cc76"><span class="cl-2045e268">0.5064538</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-2048dd4d"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4d"><p class="cl-2048cc76"><span class="cl-2045e268">0.4897629</span></p></td><td class="cl-2048dd4d"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4d"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4d"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4d"><p class="cl-2048cc76"><span class="cl-2045e268">1</span></p></td><td class="cl-2048dd4d"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4d"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4d"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4d"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4d"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4d"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4d"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4d"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4d"><p class="cl-2048cc76"><span class="cl-2045e268">0</span></p></td><td class="cl-2048dd4d"><p class="cl-2048cc76"><span class="cl-2045e268">0.5059402</span></p></td></tr></tbody></table></div>
</div>
</div>
<p>I have shown a sample of the latest design matrix above, so finally, it’s time to fit the model.</p>
</section>
<section id="second-model-run" class="level2">
<h2 class="anchored" data-anchor-id="second-model-run">Second Model Run</h2>
<p><span style="color: #BF5700;"><strong>To summarize, we added the following parameters to the second iteration of the model:</strong></span></p>
<ul>
<li><p>A GAM fit to the <code>Age</code> variable.</p></li>
<li><p>Split <code>Cabin</code> into <code>deck</code>, <code>num</code>, and <code>side</code>.</p></li>
<li><p>A GAM fit to the <code>num</code> variable.</p></li>
<li><p>A variable called <code>CabinMult</code> that is true if multiple people shared the same cabin (that we know about.)</p></li>
</ul>
<p>Let’s go ahead and fit the Stan model using the exact same Stan code as last time without modifications. This is definitely a benefit of setting model structure using a design matrix and response vector structure, since they can easily be extended to have any number of observations and predictors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>cabin_design_matrix <span class="ot">&lt;-</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  imputed_cabin_data <span class="sc">%&gt;%</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model.matrix</span>(<span class="st">`</span><span class="at">Transported</span><span class="st">`</span> <span class="sc">~</span> <span class="st">`</span><span class="at">Age_Pred</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">VIP</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">HomePlanet</span><span class="st">`</span> <span class="sc">+</span> deck <span class="sc">+</span> num <span class="sc">+</span> side <span class="sc">+</span> CabinMult <span class="sc">+</span> num_Pred, <span class="at">data =</span> .)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>cabin_response <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(imputed_cabin_data<span class="sc">$</span>Transported)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">"../../assets/models/sst_model_2.rds"</span>)){</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  sst_fit_2 <span class="ot">&lt;-</span> </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stan</span>(<span class="at">file =</span> <span class="st">"../../assets/stan/spaceship_titanic_2.stan"</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">data =</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(cabin_design_matrix),</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">K =</span> <span class="fu">ncol</span>(cabin_design_matrix),</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">X =</span> cabin_design_matrix,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">y =</span> cabin_response),</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">iter =</span> <span class="dv">2000</span>)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(sst_fit_2, <span class="at">file =</span> <span class="st">"../../assets/models/sst_model_2.rds"</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">load</span>(<span class="st">"../../assets/models/sst_model_2.rds"</span>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="roc---we-have-two-models-which-is-better" class="level2">
<h2 class="anchored" data-anchor-id="roc---we-have-two-models-which-is-better">ROC - We have two models, which is better?</h2>
<p>Let’s see what the accuracy of this new model is compared to the first one using another confusion matrix.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>y_pred_means <span class="ot">&lt;-</span> <span class="fu">apply</span>(rstan<span class="sc">::</span><span class="fu">extract</span>(sst_fit_2, <span class="st">"y_pred"</span>)<span class="sc">$</span>y_pred, <span class="dv">2</span>, mean)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>y_pred_factor <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">ifelse</span>(y_pred_means <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>cabin_response_factor <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">ifelse</span>(cabin_response <span class="sc">==</span> <span class="dv">1</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">confusionMatrix</span>(y_pred_factor, cabin_response_factor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction FALSE TRUE
     FALSE  2871 1649
     TRUE   1444 2729
                                         
               Accuracy : 0.6442         
                 95% CI : (0.634, 0.6543)
    No Information Rate : 0.5036         
    P-Value [Acc &gt; NIR] : &lt; 2.2e-16      
                                         
                  Kappa : 0.2886         
                                         
 Mcnemar's Test P-Value : 0.0002444      
                                         
            Sensitivity : 0.6654         
            Specificity : 0.6233         
         Pos Pred Value : 0.6352         
         Neg Pred Value : 0.6540         
             Prevalence : 0.4964         
         Detection Rate : 0.3303         
   Detection Prevalence : 0.5200         
      Balanced Accuracy : 0.6443         
                                         
       'Positive' Class : FALSE          
                                         </code></pre>
</div>
</div>
<p>Not bad, we’re up to over 64% accuracy!</p>
<p>Finally, we will take a look at the <a href="https://en.wikipedia.org/wiki/Receiver_operating_characteristic">ROC curve</a>, which looks at how the model performs by letting the TRUE/FALSE threshold vary from 0% to 100%.</p>
<p>The more area that is under this curve (which is a statistic called AUC, or area under the curve), the better the model performs at classification.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>roc1 <span class="ot">&lt;-</span> <span class="fu">roc</span>(cabin_response_factor, <span class="fu">apply</span>(rstan<span class="sc">::</span><span class="fu">extract</span>(sst_fit_1, <span class="st">"y_pred"</span>)<span class="sc">$</span>y_pred, <span class="dv">2</span>, mean))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>roc2 <span class="ot">&lt;-</span> <span class="fu">roc</span>(cabin_response_factor, <span class="fu">apply</span>(rstan<span class="sc">::</span><span class="fu">extract</span>(sst_fit_2, <span class="st">"y_pred"</span>)<span class="sc">$</span>y_pred, <span class="dv">2</span>, mean))</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>auc1 <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc1)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>auc2 <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc2)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>roc1_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">tpr=</span>roc1<span class="sc">$</span>sensitivities, <span class="at">fpr=</span> <span class="dv">1</span> <span class="sc">-</span> roc1<span class="sc">$</span>specificities, <span class="at">model=</span><span class="st">'Model 1'</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>roc2_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">tpr=</span>roc2<span class="sc">$</span>sensitivities, <span class="at">fpr=</span> <span class="dv">1</span> <span class="sc">-</span> roc2<span class="sc">$</span>specificities, <span class="at">model=</span><span class="st">'Model 2'</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the data frames</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>roc_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(roc1_df, roc2_df)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot with ggplot</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(roc_df, <span class="fu">aes</span>(<span class="at">x=</span>fpr, <span class="at">y=</span>tpr, <span class="at">color=</span>model)) <span class="sc">+</span> </span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">linetype=</span><span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"Model 1"</span><span class="ot">=</span><span class="st">"red"</span>, <span class="st">"Model 2"</span><span class="ot">=</span><span class="st">"blue"</span>)) <span class="sc">+</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"False Positive Rate"</span>, <span class="at">y=</span><span class="st">"True Positive Rate"</span>, <span class="at">title=</span><span class="st">"ROC Curve Comparison"</span>) <span class="sc">+</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x=</span><span class="fl">0.6</span>, <span class="at">y=</span><span class="fl">0.25</span>, <span class="at">label=</span><span class="fu">paste</span>(<span class="st">"Model 1 AUC ="</span>, <span class="fu">round</span>(auc1, <span class="dv">3</span>)), <span class="at">color=</span><span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x=</span><span class="fl">0.6</span>, <span class="at">y=</span><span class="fl">0.15</span>, <span class="at">label=</span><span class="fu">paste</span>(<span class="st">"Model 2 AUC ="</span>, <span class="fu">round</span>(auc2, <span class="dv">3</span>)), <span class="at">color=</span><span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rj_custom_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see from the ROC Curve that Model 2 has a higher True Positive rate for every possible threshold (which is denoted by moving from left to right on the x-axis) and has a larger AUC, meaning it should perform better at classification than Model 1.</p>
<p>I would hope that was the case, since I put a lot of effort into improving it. 😉</p>
</section>
<section id="summary-part-4-preview" class="level2">
<h2 class="anchored" data-anchor-id="summary-part-4-preview">Summary + Part 4 Preview</h2>
<p>Phew, that was a lot of content to get through! Thanks for sticking through it - I probably won’t try to cram much into Part 4 so that we can do a deeper dive on how the model is really performing so far.</p>
<p>Thanks again, and please <a href="../../blog_subscribe.html">subscribe to the blog</a> if you haven’t already. A lot of effort and research goes into creating this type of material, and it will make me glad if people actually subscribed and read what I enjoy writing about.</p>
<p>In Part 4, I will explore one or two more predictive variables from our data, setting priors on variables for more efficient model fitting, residual plots, and possibly <a href="https://mc-stan.org/loo/">leave-one-out</a> cross-validation if my computer decides to cooperate with that package.</p>
<div style="text-align: center;">
<p><script>window.onload = function() { var elevator = new Elevator({ element: document.querySelector(".elevator-button"),  mainAudio: "", endAudio: "ding.mp3" }); }</script><button class="btn btn-outline-primary elevator-button" type="submit">Return to the top!</button></p>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>